# PivotView: AI 智能视觉追踪云台
**PivotView** 是一个高性能、基于 AI 的二维视觉追踪云台项目。它使用 MaixCam Pro作为前端视觉感知单元，在树莓派上运行先进的控制算法，能够实现对人脸或目标的实时、平滑、智能的追踪。

该项目的核心优势在于其基于 有限状态机 (FSM) 的高级行为策略，使得云台在目标捕获、跟踪和丢失等不同场景下，都能表现出优雅且鲁棒的动态行为。

## 效果演示
(这里为项目实际运行效果的GIF动图)
## ✨ 核心功能
- 🤖 智能行为策略 (基于有限状态机)
该项目的核心是其先进的行为逻辑，通过一个有限状态机（FSM）来管理云台的各种工况，使其不仅仅是一个被动的执行器，更像一个拥有初步“思考”能力的智能体。
    - 平滑捕获 (ACQUIRING): 当一个新目标进入视野时，系统并不会粗暴地立即全速跟踪。相反，它会进入此模式，采用一个独立的、增益较低的P控制器，优雅地将目标“邀请”至画面中心。这彻底解决了传统跟踪器在初次锁定时因误差过大而导致的剧烈、不自然的甩动问题，提供了卓越的第一交互体验。

    - 高性能跟踪 (TRACKING): 一旦目标被平稳捕获至中心区域，系统会无缝切换到此核心模式。此时，一个经过精心调校的全功能PID控制器将接管云台，以极高的刷新率进行稳定、精确、平滑的实时跟随，确保目标始终保持在画面中心。
    - 螺旋搜索 (SEARCHING): 当目标因快速移动或短暂遮挡而丢失时，系统展现出其最智能的一面。它不会原地放弃，而是立刻进入搜索模式，以目标最后出现的位置为圆心，启动一个由内向外、速度适中的螺旋搜索轨迹。这种仿生学策略极大地提高了目标丢失后的重捕获成功率，让云台显得“执着”而高效。
    - 安全归位 (IDLE): 在长时间搜索无果或系统初次启动时，云台会进入此模式。它会通过一个平滑的缓动轨迹，自动、缓慢地回到预设的中心或初始位置，随后进入低功耗的等待状态，既保证了设备的安全，也降低了能源消耗。
- 🧠 高级PID控制器

    为了实现极致的跟踪效果，我们对经典的PID算法进行了三项关键的现代化改造：
    - Z轴自适应增益: 系统能够根据目标边界框的大小（即视觉上的距离）动态调整PID的P（比例）增益。当目标靠近（例如，人脸占据大部分屏幕），增益会自动降低，使云台响应更柔和，避免震荡；当目标远离（画面中只有一个小点），增益则会提高，使云台响应更灵敏，确保不会跟丢远方的小目标。这种“远快近慢”的策略是实现平滑跟踪的核心。
    - 中心死区 (Dead Zone): 为了根除目标在中心点附近时，因微小噪声或计算误差导致的舵机高频“嗡嗡”抖动问题，我们设立了一个中心死区。当目标与中心的误差小于一个预设的阈值（例如2%）时，PID输出将被强制归零，舵机将保持静止。这不仅让静止跟踪画面如磐石般稳定，还有效地减少了舵机的磨损和功耗。
    - 积分抗饱和 (Anti-Windup): 这是一个关键的鲁棒性设计。如果目标长时间移出画面，传统PID的积分项（I）会无限制地累积，形成一个巨大的“积分炸弹”。当目标再次出现时，这个巨大的积分项会导致云台严重超调，猛地甩向一个方向。我们的PID控制器为积分项设置了合理的上限和下限，有效防止了这种情况的发生，确保云台在任何时候都能保持理性和稳定。
- 🧩 模块化架构

    项目的优雅也体现在其清晰的软件架构上：
    - receivemaix: 这是一个完全解耦的串口数据接收模块。它在独立的后台线程中运行，负责处理与MaixCam的通信、数据帧解析和CRC校验，确保了无论串口数据多么频繁，主控制循环的PID运算和状态决策都绝不会被阻塞，保证了系统的实时响应能力。
    - ServoController: 这不仅仅是一个舵机驱动，更是一个功能丰富的运动控制库。它通过ServoGroup实现了对多个舵机的同步姿态控制，并且内置了多种缓动函数（Easing），使得复杂的运动可以被一行代码优雅地调用，极大地简化了主程序的逻辑，并为平滑、自然的运动效果提供了坚实的基础。
## 🛠️ 系统架构
本项目由前端的感知模块 (MaixCam) 和后端的控制模块 (树莓派) 组成，通过串口进行通信。

    [视频流] --> [MaixCam]                                      [树莓派]
                |                                                 ^
                | 1. 运行AI模型 (识别人脸)                       |
                | 2. 卡尔曼滤波 (平滑坐标)                        |
                | 3. 打包数据并通过串口发送                      |
                |                                                 |
                +---------------------( UART )--------------------->+ [receivemaix 模块]
                                                                    |
                                                                    | 1. FSM判断当前状态
                                                                    | 2. PID计算舵机运动
                                                                    | 3. 调用 ServoController
                                                                    |
                                                                    v
                                                                [舵机控制板] --> [舵机云台]


## 📁 项目结构
        .
    ├── main.py
    ├── pyproject.toml
    ├── README.md
    ├── receivemaix
    │   ├── main.py
    │   ├── pyproject.toml
    │   ├── README.md
    │   └── uv.lock
    └── ServoController
        ├── Easing_Funtion_Demo.html
        ├── LICENSE
        ├── pyproject.toml
        ├── README.md
        ├── servo_controller_library.py
        ├── servo_demostration.ipynb
        └── uv.lock

## 🚀 安装与部署
### 硬件要求
- 树莓派 (推荐 Raspberry Pi 4B/5)
- MaixCam Pro 或其他能通过串口发送坐标的AI摄像头
- 二维舵机云台 (带2个舵机, 如SG90/MG90S)
- PCA9685 16路舵机驱动板
- 独立的舵机电源 (如 5V/2A 电源适配器或2S锂电池)
- 杜邦线若干
### 软件设置
- 本项目使用 uv 进行Python环境和包管理。
1. 克隆仓库
    ```bash
        git clone https://github.com/StanleyChanH/Pivotview.git

        cd PivotView
    ```

2. 创建并激活Python虚拟环境
    ```bash
    uv venv
    source .venv/bin/activate
    ```

3. 安装依赖库
本项目依赖 pyserial (用于串口通信) 和 smbus (用于I2C通信)。
    ```bash
    uv sync
    ```

4. 安装本地子模块

    为了让主程序能正确导入 receivemaix 和 ServoController，需要以可编辑模式安装它们。
    ```bash
    cd receivemaix
    uv sync
    cd ../ServoController
    uv sync
    ```

## ⚙️ 配置
所有关键参数都集中在 main.py 的顶部配置区，你可以根据自己的硬件和需求进行调整：
- **串口配置:** SERIAL_PORT, BAUDRATE
- **舵机配置:** H_SERVO_CHANNEL, V_SERVO_CHANNEL, H_SERVO_MAX_ANGLE, 安全范围百分比等。
- **行为策略:** TARGET_LOST_TIMEOUT, SEARCH_TIMEOUT, ACQUIRE_KP 等。
- **PID参数:** CENTER_DEAD_ZONE, ADAPTIVE_GAIN_ENABLED 以及 base_pid_h 和 base_pid_v 中的 Kp, Ki, Kd 值。

提示: PID参数的整定（Tuning）是获得最佳效果的关键，建议在实际运行中反复调试 Kp, Ki, Kd 的值。
## ▶️ 运行
确保所有硬件连接正确，尤其是舵机电源独立供电。然后运行主程序：
```bash
uv run main.py
```

程序启动后，你会看到终端输出当前的初始化步骤和状态变化。按 Ctrl+C 可以安全退出程序，云台会自动归中。
## 📄 许可证
本项目采用 MIT License 授权。
